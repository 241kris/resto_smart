// ---------------------------------------
//  Prisma Generator & Datasource
// ---------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------
//  MODELS
// ---------------------------------------

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  // Relation 1 → 1 (un seul établissement)
  establishment Establishment?
}

model Establishment {
  id          String  @id @default(uuid())
  name        String
  slug        String 
  description String? 
  email       String?
  phones      Json    // Array de numéros de téléphone ["0123456789", "0987654321"]
  images      Json    // Array d'URLs d'images (max 7) ["url1", "url2", ...]
  address     Json?    // Objet adresse structuré {street, city, postalCode, country}
  latitude    Float?
  longitude   Float?

  // Relation vers User
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations vers catégories et produits
  categories Category[]
  products   Product[]

  createdAt DateTime @default(now())

  tables Table[]

  orders Order[]
}

model Category {
  id      String  @id @default(uuid())
  name    String
  deleted Boolean @default(false)

  // Relation vers Establishment
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  // Produits associés à cette catégorie
  products Product[]
}

model Product {
  id          String  @id @default(uuid())
  name        String
  image       String?
  price       Float
  description String?

  // Relation vers Establishment
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  // Relation vers Category (optionnel)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  orderItems OrderItem[]
}

model Table {
  id          String @id @default(cuid())
  // ID interne unique
  number      Int // Numéro visible (peut se répéter)
  tableToken  String @unique // Token unique pour QR / URL
  qrUrl       String // URL complète encodée dans le QR Code
  qrCodePath  String // Chemin vers l'image QR Code dans /public

  restaurantId String
  restaurant   Establishment @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
}


model Order {
  id            String      @id @default(cuid())

  restaurantId  String
  restaurant    Establishment @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  tableId       String?
  table         Table?        @relation(fields: [tableId], references: [id], onDelete: Cascade)

  // Montant total de la commande au moment du passage
  totalAmount   Float

  // Statut de la commande
  status        OrderStatus @default(PENDING)

  // Informations client pour les commandes publiques (optionnel)
  customer      Json?

  // Produits commandés
  items         OrderItem[]


  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}



model OrderItem {
  id          String   @id @default(cuid())

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity    Int
  price       Float      // prix unitaire au moment de la commande
  total       Float      // quantity * price
}
enum OrderStatus {
  PENDING  // en cours
  PAID //payé
  CANCELLED//annulé
  completed //traité 

}
